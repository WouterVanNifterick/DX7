unit DX7.PitchEnv;

interface

uses
  DX7.Config,
  FS1R.Params;

type
  TEnvState=(attack,decay,sustain,off);

  TPitchEnvelopeDX7=record
  strict private
    Levels:^TLevels;
    Rates:^TRates;
    Params:pVoiceParams;
    Index:integer;
    Level:Double;
    down:Boolean;
    TargetLevel:integer;
    rising:boolean;
    unit_:integer;
    procedure advance(newstate:integer);
  public
    state:integer;
    DecayIncrement:Double;
    CurrentOutput:Double;
    function Render:double;
    constructor Create(aParams:PVoiceParams);
    function isFinished:boolean;
    procedure noteOff;
  end;

const

// 255   ┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼─────
// 241.6 |      |      |      |      |      |      |      |      |      |    █
// 228.3 ┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼────█
// 214.9 |      |      |      |      |      |      |      |      |      |   ██
// 201.5 ┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──███
// 188.2 |      |      |      |      |      |      |      |      |      |▄████
// 174.8 ┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────▄█████
// 161.4 |      |      |      |      |      |      |      |      |     ███████
// 148.1 ┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼───▄████████
// 134.7 |      |      |      |      |      |      |      |      |  ██████████
// 121.3 ┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼▄███████████
// 107.9 |      |      |      |      |      |      |      |    ▄██████████████
//  94.6 ┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──▄████████████████
//  81.2 |      |      |      |      |      |      |     ▄▄███████████████████
//  67.8 ┼──────┼──────┼──────┼──────┼──────┼──────┼─▄▄███████████████████████
//  54.5 |      |      |      |      |      |   ▄▄████████████████████████████
//  41.1 ┼──────┼──────┼──────┼──────┼───▄▄▄▄█████████████████████████████████
//  27.7 |      |      |      |   ▄▄▄▄████████████████████████████████████████
//  14.4 ┼──────┼──▄▄▄▄▄▄▄▄███████████████████████████████████████████████████
//     1 |████████████████████████████████████████████████████████████████████
//      ─|──────|──────|──────|──────|──────|──────|──────|──────|──────|──────
//       0      10     20     30     40     50     60     70     80     90
pitchenv_rate:array[0..99] of byte=(
  1, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12,
  12, 13, 13, 14, 14, 15, 16, 16, 17, 18, 18, 19, 20, 21, 22, 23, 24,
  25, 26, 27, 28, 30, 31, 33, 34, 36, 37, 38, 39, 41, 42, 44, 46, 47,
  49, 51, 53, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74, 76, 79, 82,
  85, 88, 91, 94, 98, 102, 106, 110, 115, 120, 125, 130, 135, 141, 147,
  153, 159, 165, 171, 178, 185, 193, 202, 211, 232, 243, 254, 255
);


//   128 ┼───────┼────────┼───────┼───────┼────────┼───────┼───────┼────────┼───────┼───────┼
//   120 |       |        |       |       |        |       |       |        |       |       █
//   112 ┼───────┼────────┼───────┼───────┼────────┼───────┼───────┼────────┼───────┼──────▄█
//   104 |       |        |       |       |        |       |       |        |       |      ██
//    96 ┼───────┼────────┼───────┼───────┼────────┼───────┼───────┼────────┼───────┼─────███
//    88 |       |        |       |       |        |       |       |        |       |    ▄███
//    80 ┼───────┼────────┼───────┼───────┼────────┼───────┼───────┼────────┼───────┼────████
//    72 |       |        |       |       |        |       |       |        |       |   █████
//    64 ┼───────┼────────┼───────┼───────┼────────┼───────┼───────┼────────┼───────┼──▄█████
//    56 |       |        |       |       |        |       |       |        |       | ▄██████
//    48 ┼───────┼────────┼───────┼───────┼────────┼───────┼───────┼────────┼───────▄████████
//    40 |       |        |       |       |        |       |       |        |    ▄▄██████████
//    32 ┼───────┼────────┼───────┼───────┼────────┼───────┼───────┼───────▄▄▄███████████████
//    24 |       |        |       |       |        |       |       | ▄▄▄█████████████████████
//    16 ┼───────┼────────┼───────┼───────┼────────┼───────┼──▄▄▄████████████████████████████
//     8 |       |        |       |       |        |   ▄▄▄███████████████████████████████████
//     0 ┼───────┼────────┼───────┼───────┼─────▄▄▄▄█████████████████████████████████████████
//    -8 |       |        |       |       ▄▄▄████████████████████████████████████████████████
//   -16 ┼───────┼────────┼───────┼▄▄▄███████████████████████████████████████████████████████
//   -24 |       |        | ▄▄▄▄█████████████████████████████████████████████████████████████
//   -32 ┼───────┼─────▄▄████████████████████████████████████████████████████████████████████
//   -40 |       |  ▄████████████████████████████████████████████████████████████████████████
//   -48 ┼───────┼███████████████████████████████████████████████████████████████████████████
//   -56 |      ▄████████████████████████████████████████████████████████████████████████████
//   -64 ┼─────▄█████████████████████████████████████████████████████████████████████████████
//   -72 |    ███████████████████████████████████████████████████████████████████████████████
//   -80 ┼───▄███████████████████████████████████████████████████████████████████████████████
//   -88 |   ████████████████████████████████████████████████████████████████████████████████
//   -96 ┼──█████████████████████████████████████████████████████████████████████████████████
//  -104 |  █████████████████████████████████████████████████████████████████████████████████
//  -112 ┼─██████████████████████████████████████████████████████████████████████████████████
//  -120 |▄██████████████████████████████████████████████████████████████████████████████████
//  -128 ┼███████████████████████████████████████████████████████████████████████████████████
//      ─┼───────┼────────┼───────┼───────┼────────┼───────┼───────┼────────┼───────┼───────┼─
//       0       10       20      30      40       50      60      70       80      90     100
pitchenv_tab:array[0..99] of shortint=(
  -128, -116, -104, -95, -85, -76, -68, -61, -56, -52, -49, -46, -43,
  -41, -39, -37, -35, -33, -32, -31, -30, -29, -28, -27, -26, -25, -24,
  -23, -22, -21, -20, -19, -18, -17, -16, -15, -14, -13, -12, -11, -10,
  -9, -8, -7, -6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10,
  11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27,
  28, 29, 30, 31, 32, 33, 34, 35, 38, 40, 43, 46, 49, 53, 58, 65, 73,
  82, 92, 103, 115, 127
);

var outputLUT:array of double = [];

implementation

uses Math,SysUtils,Windows;

const
  ENV_OFF = 4;


constructor TPitchEnvelopeDX7.Create(aParams: PVoiceParams);
begin
  Params := aParams;
  index := -1;
  unit_ := round({N}1 * (1 shl 24) / (21.3 * Config.sampleRate) + 0.5);

	levels := @Params.Common.PitchEG.Envelope.Levels;
	rates := @Params.Common.PitchEG.Envelope.Rates;

	level := levels[3];
	down := true;
	decayIncrement := 0;
	advance(0);
end;


function TPitchEnvelopeDX7.render:double;
begin
  Exit(1);
	if (state < 3) or ((state < 4) and (not down)) then
  begin
    if rising then begin
      level := level + decayIncrement;
      if (level >= targetlevel) then begin
        level := targetlevel;
        advance(state + 1);
      end
    end else begin
      // not rising
      level := level - DecayIncrement;
      if (level <= targetlevel) then begin
        level := targetlevel;
        advance(state + 1);
      end;
    end;
  end;
	Result := self.Level ;
  CurrentOutput := Result;
end;

procedure TPitchEnvelopeDX7.advance(newstate:integer);
var newlevel:integer;
begin
	self.state := newstate;
	if (self.state < 4) then begin
		newlevel := self.levels[self.state];
		targetlevel := pitchenv_tab[newlevel] shl 19;
		rising := self.targetlevel > self.level;
		self.decayIncrement := pitchenv_rate[rates[State]] * unit_;
	end;
end;

procedure TPitchEnvelopeDX7.noteOff;
begin
	down := false;
	advance(3);
end;

function TPitchEnvelopeDX7.isFinished:boolean;
begin
	Result := state = ENV_OFF;
end;

initialization

end.
