unit FM.Oscillator;

interface

type
  TWaveForm = (
      sinus,
      opl2_w1,
      opl2_w2,
      opl2_w3,
      opl2_w4,

      op4_w1,
      op4_w2,
      op4_w3,
      op4_w4,
      op4_w5,
      op4_w6,
      op4_w7,
      op4_w8
      );

/// <summary>
///
/// </summary>
function GetOsc(WaveForm:TWaveForm; phase: double): double;
//function GetSine(phi:double):double;

implementation

uses Math;

function GetOsc(Waveform:TWaveForm; phase: double): double;
var
  y, y2, y3, y4, p : double;
begin
  p  := FMod(phase,2*pi);
  y  := sin(phase);
  y2 := sin(phase*2);
  y3 := sin(phase+pi*0.5);
  y4 := sin((phase+pi)*2+pi*0.5);

  // use upper two bits to mangle waveform

  case WaveForm of

//     1 ┼─────────┼─────────▄▄▄▄▄▀▄▄▄▄▄─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.900 |         |      ▄▀▀|         |▀▀▄      |         |         |         |         |         |
// 0.800 ┼─────────┼───▄▀▀───┼─────────┼───▀▀▄───┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.700 |         | ▄▀      |         |      ▀▄ |         |         |         |         |         |
// 0.600 ┼─────────▄▀────────┼─────────┼────────▀▄─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.500 |       ▄▀|         |         |         |▀▄       |         |         |         |         |
// 0.400 ┼─────▄▀──┼─────────┼─────────┼─────────┼──▀▄─────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.300 |    ▀    |         |         |         |    ▀    |         |         |         |         |
// 0.200 ┼──▄▀─────┼─────────┼─────────┼─────────┼─────▀▄──┼─────────┼─────────┼─────────┼─────────┼────────
// 0.100 |▄▀       |         |         |         |       ▀▄|         |         |         |         |
//     0 ▀─────────┼─────────┼─────────┼─────────┼─────────▀─────────┼─────────┼─────────┼─────────┼────────
//-0.100 |         |         |         |         |         |▀▄       |         |         |         |       ▄
//-0.200 ┼─────────┼─────────┼─────────┼─────────┼─────────┼──▀▄─────┼─────────┼─────────┼─────────┼─────▄▀─
//-0.300 |         |         |         |         |         |    ▄    |         |         |         |    ▄
//-0.400 ┼─────────┼─────────┼─────────┼─────────┼─────────┼─────▀▄──┼─────────┼─────────┼─────────┼──▄▀────
//-0.500 |         |         |         |         |         |       ▀▄|         |         |         |▄▀
//-0.600 ┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────▀▄────────┼─────────┼────────▄▀────────
//-0.700 |         |         |         |         |         |         | ▀▄      |         |      ▄▀ |
//-0.800 ┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼───▀▄▄───┼─────────┼───▄▄▀───┼────────
//-0.900 |         |         |         |         |         |         |      ▀▄▄|         |▄▄▀      |
//    -1 ┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────▀▀▀▀▀▀▀▀▀▀▀─────────┼────────
//      ─┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────
//       0         10        20        30        40        50        60        70        80        90
    sinus  ,
    opl2_w1 : ; // sine


//     1 ┼─────────┼─────────┼─▄▄▄▀▄▄▄─┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.950 |         |        ▄▀▀       ▀▀▄        |         |         |         |         |         |
// 0.900 ┼─────────┼──────▄▀─┼─────────┼─▀▄──────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.850 |         |     ▄   |         |   ▄     |         |         |         |         |         |
// 0.800 ┼─────────┼────▀────┼─────────┼────▀────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.750 |         |  ▄▀     |         |     ▀▄  |         |         |         |         |         |
// 0.700 ┼─────────┼─▄───────┼─────────┼───────▄─┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.650 |         |▄        |         |        ▄|         |         |         |         |         |
// 0.600 ┼─────────▄─────────┼─────────┼─────────▄─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.550 |        ▄|         |         |         |▄        |         |         |         |         |
// 0.500 ┼───────▄─┼─────────┼─────────┼─────────┼─▄───────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.450 |      ▄  |         |         |         |  ▄      |         |         |         |         |
// 0.400 ┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.350 |     ▀   |         |         |         |   ▀     |         |         |         |         |
// 0.300 ┼────▀────┼─────────┼─────────┼─────────┼────▀────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.250 |   ▄     |         |         |         |     ▄   |         |         |         |         |
// 0.200 ┼──▄──────┼─────────┼─────────┼─────────┼──────▄──┼─────────┼─────────┼─────────┼─────────┼────────
// 0.150 | ▄       |         |         |         |       ▄ |         |         |         |         |
// 0.100 ┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.050 |▀        |         |         |         |        ▀|         |         |         |         |
//     0 ▀─────────┼─────────┼─────────┼─────────┼─────────▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
//      ─┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────
//       0         10        20        30        40        50        60        70        80        90

    opl2_w2 : if y<0 then y := 0; // sine>0

//     1 ┼─────────┼─────────┼─▄▄▄▀▄▄▄─┼─────────┼─────────┼─────────┼─────────┼─▄▄▄▀▄▄▄─┼─────────┼────────
// 0.950 |         |        ▄▀▀       ▀▀▄        |         |         |        ▄▀▀       ▀▀▄        |
// 0.900 ┼─────────┼──────▄▀─┼─────────┼─▀▄──────┼─────────┼─────────┼──────▄▀─┼─────────┼─▀▄──────┼────────
// 0.850 |         |     ▄   |         |   ▄     |         |         |     ▄   |         |   ▄     |
// 0.800 ┼─────────┼────▀────┼─────────┼────▀────┼─────────┼─────────┼────▀────┼─────────┼────▀────┼────────
// 0.750 |         |  ▄▀     |         |     ▀▄  |         |         |  ▄▀     |         |     ▀▄  |
// 0.700 ┼─────────┼─▄───────┼─────────┼───────▄─┼─────────┼─────────┼─▄───────┼─────────┼───────▄─┼────────
// 0.650 |         |▄        |         |        ▄|         |         |▄        |         |        ▄|
// 0.600 ┼─────────▄─────────┼─────────┼─────────▄─────────┼─────────▄─────────┼─────────┼─────────▄────────
// 0.550 |        ▄|         |         |         |▄        |        ▄|         |         |         |▄
// 0.500 ┼───────▄─┼─────────┼─────────┼─────────┼─▄───────┼───────▄─┼─────────┼─────────┼─────────┼─▄──────
// 0.450 |      ▄  |         |         |         |  ▄      |      ▄  |         |         |         |  ▄
// 0.400 ┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.350 |     ▀   |         |         |         |   ▀     |     ▀   |         |         |         |   ▀
// 0.300 ┼────▀────┼─────────┼─────────┼─────────┼────▀────┼────▀────┼─────────┼─────────┼─────────┼────▀───
// 0.250 |   ▄     |         |         |         |     ▄   |   ▄     |         |         |         |     ▄
// 0.200 ┼──▄──────┼─────────┼─────────┼─────────┼──────▄──┼──▄──────┼─────────┼─────────┼─────────┼──────▄─
// 0.150 | ▄       |         |         |         |       ▄ | ▄       |         |         |         |       ▄
// 0.100 ┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.050 |▀        |         |         |         |        ▀|▀        |         |         |         |
//     0 ▀─────────┼─────────┼─────────┼─────────┼─────────▀─────────┼─────────┼─────────┼─────────┼────────
//      ─┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────
//       0         10        20        30        40        50        60        70        80        90

    opl2_w3: if p>pi then y := -y; // |sine| (maybe abs(y) would work too

//     1 ┼─────────┼─────────┼─████────┼─────────┼─────────┼─────────┼─────────┼─████────┼─────────┼────────
// 0.950 |         |        ▄▄█████    |         |         |         |        ▄▄█████    |         |
// 0.900 ┼─────────┼──────▄▄███████────┼─────────┼─────────┼─────────┼──────▄▄███████────┼─────────┼────────
// 0.850 |         |     ▄█████████    |         |         |         |     ▄█████████    |         |
// 0.800 ┼─────────┼────███████████────┼─────────┼─────────┼─────────┼────███████████────┼─────────┼────────
// 0.750 |         |  ▄████████████    |         |         |         |  ▄████████████    |         |
// 0.700 ┼─────────┼─▄█████████████────┼─────────┼─────────┼─────────┼─▄█████████████────┼─────────┼────────
// 0.650 |         |▄██████████████    |         |         |         |▄██████████████    |         |
// 0.600 ┼─────────▄███████████████────┼─────────┼─────────┼─────────▄███████████████────┼─────────┼────────
// 0.550 |        ▄████████████████    |         |         |        ▄████████████████    |         |
// 0.500 ┼───────▄█████████████████────┼─────────┼─────────┼───────▄█████████████████────┼─────────┼────────
// 0.450 |      ▄██████████████████    |         |         |      ▄██████████████████    |         |
// 0.400 ┼──────███████████████████────┼─────────┼─────────┼──────███████████████████────┼─────────┼────────
// 0.350 |     ████████████████████    |         |         |     ████████████████████    |         |
// 0.300 ┼────▄████████████████████────┼─────────┼─────────┼────▄████████████████████────┼─────────┼────────
// 0.250 |   ▄█████████████████████    |         |         |   ▄█████████████████████    |         |
// 0.200 ┼──▄██████████████████████────┼─────────┼─────────┼──▄██████████████████████────┼─────────┼────────
// 0.150 | ▄███████████████████████    |         |         | ▄███████████████████████    |         |
// 0.100 ┼─████████████████████████────┼─────────┼─────────┼─████████████████████████────┼─────────┼────────
// 0.050 |█████████████████████████    |         |         |█████████████████████████    |         |
//     0  ██████████████████████████████████████████████████████████████████████████████████████████████████
//      ─┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────
//       0         10        20        30        40        50        60        70        80        90
    opl2_w4: begin
              if p > pi then y := -y;

                   if (p > 0.5 * pi) and (p < 1 * pi) then y := 0
              else if (p > 1.5 * pi) and (p < 2 * pi) then y := 0;
            end;

   // Sine wave. Only fundamental:
    op4_w1: ;

//     1 ┼─────────┼─────────┼────█────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.900 |         |         |  ██ ██  |         |         |         |         |         |         |
// 0.800 ┼─────────┼─────────┼██─────██┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.700 |         |         █         █         |         |         |         |         |         |
// 0.600 ┼─────────┼───────██┼─────────┼██───────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.500 |         |     ██  |         |  ██     |         |         |         |         |         |
// 0.400 ┼─────────┼───██────┼─────────┼────██───┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.300 |         | ██      |         |      ██ |         |         |         |         |         |
// 0.200 ┼────────███────────┼─────────┼────────███────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.100 |     ███ |         |         |         | ███     |         |         |         |         |
//     0 ┼█████────┼─────────┼─────────┼─────────┼────███████████────┼─────────┼─────────┼─────────┼────████
//-0.100 |         |         |         |         |         |     ███ |         |         |         | ███
//-0.200 ┼─────────┼─────────┼─────────┼─────────┼─────────┼────────███────────┼─────────┼────────███───────
//-0.300 |         |         |         |         |         |         | ██      |         |      ██ |
//-0.400 ┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼───██────┼─────────┼────██───┼────────
//-0.500 |         |         |         |         |         |         |     ██  |         |  ██     |
//-0.600 ┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼───────██┼─────────┼██───────┼────────
//-0.700 |         |         |         |         |         |         |         █         █         |
//-0.800 ┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼██─────██┼─────────┼────────
//-0.900 |         |         |         |         |         |         |         |  ██ ██  |         |
//    -1 ┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────█────┼─────────┼────────
//      ─┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────
//       0         10        20        30        40        50        60        70        80        90

    // Off partials, somewhat like square wave:
    op4_w2: if p<pi then
              y := 1 - abs(y3)
            else
              y := -1 + abs(y3);


//     1 ┼─────────┼─────────┼─███████─┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.950 |         |        ███       ███        |         |         |         |         |         |
// 0.900 ┼─────────┼──────██─┼─────────┼─██──────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.850 |         |     █   |         |   █     |         |         |         |         |         |
// 0.800 ┼─────────┼────█────┼─────────┼────█────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.750 |         |  ██     |         |     ██  |         |         |         |         |         |
// 0.700 ┼─────────┼─█───────┼─────────┼───────█─┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.650 |         |█        |         |        █|         |         |         |         |         |
// 0.600 ┼─────────█─────────┼─────────┼─────────█─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.550 |        █|         |         |         |█        |         |         |         |         |
// 0.500 ┼───────█─┼─────────┼─────────┼─────────┼─█───────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.450 |      █  |         |         |         |  █      |         |         |         |         |
// 0.400 ┼─────█───┼─────────┼─────────┼─────────┼───█─────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.350 |     █   |         |         |         |   █     |         |         |         |         |
// 0.300 ┼────█────┼─────────┼─────────┼─────────┼────█────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.250 |   █     |         |         |         |     █   |         |         |         |         |
// 0.200 ┼──█──────┼─────────┼─────────┼─────────┼──────█──┼─────────┼─────────┼─────────┼─────────┼────────
// 0.150 | █       |         |         |         |       █ |         |         |         |         |
// 0.100 ┼─█───────┼─────────┼─────────┼─────────┼───────█─┼─────────┼─────────┼─────────┼─────────┼────────
// 0.050 |█        |         |         |         |        █|         |         |         |         |
//     0  ─────────┼─────────┼─────────┼─────────┼─────────█████████████████████████████████████████████████
//      ─┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────
//       0         10        20        30        40        50        60        70        80        90

    // Even partials:
    op4_w3: if y<0 then y := 0;


//     1 ┼─────────┼─────────┼────█────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.950 |         |         |   █ █   |         |         |         |         |         |         |
// 0.900 ┼─────────┼─────────┼───█─█───┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.850 |         |         |  █   █  |         |         |         |         |         |         |
// 0.800 ┼─────────┼─────────┼─█─────█─┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.750 |         |         |█       █|         |         |         |         |         |         |
// 0.700 ┼─────────┼─────────█─────────█─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.650 |         |        █|         |█        |         |         |         |         |         |
// 0.600 ┼─────────┼───────█─┼─────────┼─█───────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.550 |         |       █ |         | █       |         |         |         |         |         |
// 0.500 ┼─────────┼──────█──┼─────────┼──█──────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.450 |         |     █   |         |   █     |         |         |         |         |         |
// 0.400 ┼─────────┼────█────┼─────────┼────█────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.350 |         |   █     |         |     █   |         |         |         |         |         |
// 0.300 ┼─────────┼──█──────┼─────────┼──────█──┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.250 |         |██       |         |       ██|         |         |         |         |         |
// 0.200 ┼─────────█─────────┼─────────┼─────────█─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.150 |        █|         |         |         |█        |         |         |         |         |
// 0.100 ┼──────██─┼─────────┼─────────┼─────────┼─██──────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.050 |   ███   |         |         |         |   ███   |         |         |         |         |
//     0     ──────┼─────────┼─────────┼─────────┼──────████████████████████████████████████████████████████
//      ─┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────
//       0         10        20        30        40        50        60        70        80        90

    // Partials 2,3,5,7,...
    op4_w4: if p<pi then
              y := 1-abs(y3)
            else
              y := 0;


// 0.998 ┼─────────██████────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.898 |        █|     █   |         |         |         |         |         |         |         |
// 0.798 ┼──────██─┼──────██─┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.699 |     █   |        █|         |         |         |         |         |         |         |
// 0.599 ┼────█────┼─────────█─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.499 |   █     |         |█        |         |         |         |         |         |         |
// 0.399 ┼──█──────┼─────────┼─█───────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.299 | █       |         | █       |         |         |         |         |         |         |
// 0.200 ┼─█───────┼─────────┼──█──────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
// 0.100 |█        |         |   █     |         |         |         |         |         |         |
//     0  ─────────┼─────────┼────█────┼─────────┼─────────█████████████████████████████████████████████████
//-0.100 |         |         |     █   |         |        █|         |         |         |         |
//-0.200 ┼─────────┼─────────┼──────█──┼─────────┼───────█─┼─────────┼─────────┼─────────┼─────────┼────────
//-0.299 |         |         |       █ |         |       █ |         |         |         |         |
//-0.399 ┼─────────┼─────────┼───────█─┼─────────┼──────█──┼─────────┼─────────┼─────────┼─────────┼────────
//-0.499 |         |         |        █|         |     █   |         |         |         |         |
//-0.599 ┼─────────┼─────────┼─────────█─────────┼────█────┼─────────┼─────────┼─────────┼─────────┼────────
//-0.699 |         |         |         |█        |   █     |         |         |         |         |
//-0.798 ┼─────────┼─────────┼─────────┼─██──────┼─██──────┼─────────┼─────────┼─────────┼─────────┼────────
//-0.898 |         |         |         |   █     |█        |         |         |         |         |
//-0.998 ┼─────────┼─────────┼─────────┼────██████─────────┼─────────┼─────────┼─────────┼─────────┼────────
//      ─┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────
//       0         10        20        30        40        50        60        70        80        90

    // Partials ,2,3,6,7,9,... (stronger fundamentals than W4). Second partial is stronger than fundamental.
    op4_w5: if p < pi then
              y := y2
            else
              y := 0;


// 0.937 ┼─────────┼────▀────┼─────────┼─────────┼─────────┼────────┼─────────┼─────────┼─────────┼────────
// 0.843 |         |   ▀ ▀   |         |         |         |        |         |         |         |
// 0.750 ┼─────────┼──▀───▀──┼─────────┼─────────┼─────────┼────────┼─────────┼─────────┼─────────┼────────
// 0.656 |         | ▄     ▄ |         |         |         |        |         |         |         |
// 0.562 ┼─────────┼▄───────▄┼─────────┼─────────┼─────────┼────────┼─────────┼─────────┼─────────┼────────
// 0.469 |         |         |         |         |         |        |         |         |         |
// 0.375 ┼─────────▀─────────▀─────────┼─────────┼─────────┼────────┼─────────┼─────────┼─────────┼────────
// 0.281 |        ▀|         |▀        |         |         |        |         |         |         |
// 0.187 ┼──────▄▀─┼─────────┼─▀▄──────┼─────────┼─────────┼────────┼─────────┼─────────┼─────────┼────────
// 0.094 |    ▄▀   |         |   ▀▄    |         |         |        |         |         |         |
//     0 ┼──▀▀─────┼─────────┼─────▀▀▄▄┼─────────┼─────────┼▄▄▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
//-0.094 |         |         |         ▀▄        |        ▄▀        |         |         |         |
//-0.187 ┼─────────┼─────────┼─────────┼─▀▄──────┼──────▄▀─┼────────┼─────────┼─────────┼─────────┼────────
//-0.281 |         |         |         |   ▄     |     ▄   |        |         |         |         |
//-0.375 ┼─────────┼─────────┼─────────┼────▄────┼────▄────┼────────┼─────────┼─────────┼─────────┼────────
//-0.469 |         |         |         |         |         |        |         |         |         |
//-0.562 ┼─────────┼─────────┼─────────┼─────▀───┼───▀─────┼────────┼─────────┼─────────┼─────────┼────────
//-0.656 |         |         |         |      ▀  |  ▀      |        |         |         |         |
//-0.750 ┼─────────┼─────────┼─────────┼───────▄─┼─▄───────┼────────┼─────────┼─────────┼─────────┼────────
//-0.843 |         |         |         |        ▄|▄        |        |         |         |         |
//-0.937 ┼─────────┼─────────┼─────────┼─────────▀─────────┼────────┼─────────┼─────────┼─────────┼────────
//      ─┼─────────┼─────────┼─────────┼─────────┼─────────┼────────┼─────────┼─────────┼─────────┼─────────
//       0         10        20        30        40        50       60        70        80        90

    // Partials 2,3,5,6,7,9,11, .. (no 4,8,..). Second partial is stronger than fundamental.
    op4_w6: if p < pi then
            begin
              if p < pi * 0.5 then
                y := 1 - abs(y4)
              else
                y := -1 + abs(y4);
            end
            else
              y:=0;


//     1 ┼─────────┼▄▄▄▄─────┼─────────┼──────▄▄▄▄─────────┼─────────┼─────────┼─────────┼─────────┼───────
// 0.950 |         ▄█████▄   |         |    ▄██████        |         |         |         |         |
// 0.900 ┼─────────███████───┼─────────┼────███████────────┼─────────┼─────────┼─────────┼─────────┼───────
// 0.850 |        █████████  |         |   █████████       |         |         |         |         |
// 0.800 ┼───────███████████─┼─────────┼──███████████──────┼─────────┼─────────┼─────────┼─────────┼───────
// 0.750 |      ▄███████████▄|         | ▄███████████▄     |         |         |         |         |
// 0.700 ┼──────█████████████┼─────────┼─█████████████─────┼─────────┼─────────┼─────────┼─────────┼───────
// 0.650 |     ▄█████████████▄         |▄█████████████▄    |         |         |         |         |
// 0.600 ┼─────███████████████─────────┼███████████████────┼─────────┼─────────┼─────────┼─────────┼───────
// 0.550 |    ▄███████████████▄        ▄███████████████▄   |         |         |         |         |
// 0.500 ┼────█████████████████────────█████████████████───┼─────────┼─────────┼─────────┼─────────┼───────
// 0.450 |    █████████████████        █████████████████   |         |         |         |         |
// 0.400 ┼───███████████████████──────███████████████████──┼─────────┼─────────┼─────────┼─────────┼───────
// 0.350 |   ███████████████████      ███████████████████  |         |         |         |         |
// 0.300 ┼──█████████████████████────█████████████████████─┼─────────┼─────────┼─────────┼─────────┼───────
// 0.250 |  █████████████████████    █████████████████████ |         |         |         |         |
// 0.200 ┼─▄█████████████████████▄──▄█████████████████████▄┼─────────┼─────────┼─────────┼─────────┼───────
// 0.150 | ███████████████████████  ███████████████████████|         |         |         |         |
// 0.100 ┼─███████████████████████──███████████████████████┼─────────┼─────────┼─────────┼─────────┼───────
// 0.050 |██████████████████████████████████████████████████         |         |         |         |
//     0 ┼█████████████████████████████████████████████████████████████████████████████████████████████████
//      ─┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────
//       0         10        20        30        40        50        60        70        80        90

    // Partials 3,4,5,7,8,9, .. (no 2,6,10,...)
    op4_w7: if p < pi then
            begin
              if y2 < 0 then
                y := -y2
              else
                y := y2;
            end
            else
              y:=0;


//     1 ┼─────────┼─────────┼─────────┼─────────┼─────────┼────────┼─────────┼─────────┼─────────┼────────
// 0.950 |         |  █      |         |       █ |         |        |         |         |         |
// 0.900 ┼─────────┼─██──────┼─────────┼──────██─┼─────────┼────────┼─────────┼─────────┼─────────┼────────
// 0.850 |         | ███     |         |      ███|         |        |         |         |         |
// 0.800 ┼─────────┼─███─────┼─────────┼──────███┼─────────┼────────┼─────────┼─────────┼─────────┼────────
// 0.750 |         |█████    |         |     █████         |        |         |         |         |
// 0.700 ┼─────────┼█████────┼─────────┼─────█████─────────┼────────┼─────────┼─────────┼─────────┼────────
// 0.650 |         ▄█████▄   |         |    ▄█████▄        |        |         |         |         |
// 0.600 ┼─────────███████───┼─────────┼────███████────────┼────────┼─────────┼─────────┼─────────┼────────
// 0.550 |         ███████   |         |    ███████        |        |         |         |         |
// 0.500 ┼────────█████████──┼─────────┼───█████████───────┼────────┼─────────┼─────────┼─────────┼────────
// 0.450 |        █████████  |         |   █████████       |        |         |         |         |
// 0.400 ┼───────███████████─┼─────────┼──███████████──────┼────────┼─────────┼─────────┼─────────┼────────
// 0.350 |       ███████████ |         |  ███████████      |        |         |         |         |
// 0.300 ┼──────█████████████┼─────────┼─█████████████─────┼────────┼─────────┼─────────┼─────────┼────────
// 0.250 |     ▄█████████████▄         |▄█████████████▄    |        |         |         |         |
// 0.200 ┼─────███████████████─────────┼███████████████────┼────────┼─────────┼─────────┼─────────┼────────
// 0.150 |    █████████████████        █████████████████   |        |         |         |         |
// 0.100 ┼───▄█████████████████▄──────▄█████████████████▄──┼────────┼─────────┼─────────┼─────────┼────────
// 0.050 |  █████████████████████    █████████████████████ |        |         |         |         |
//     0 ┼█████████████████████████████████████████████████████████████████████████████████████████████████
//      ─┼─────────┼─────────┼─────────┼─────────┼─────────┼────────┼─────────┼─────────┼─────────┼─────────
//       0         10        20        30        40        50       60        70        80        90

    // Partials 3,4,5,7,8,11, ... (no 2,6,8,19,...)

    op4_w8: if p < pi then
              y := 1-abs(y4)
            else
              y:=0;
  end;

  Result := y
end;


end.
