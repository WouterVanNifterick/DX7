unit DX7.LFO;

interface

uses
  DX7.Config,
  FS1R.Params;

type
  TLFODelayAr=array[TLFODelayStage] of double;
  TLfoDX7=record
  strict private
    FParams      : PVoiceParams;
    FDelay       : double;
    FOpIndex     : TOperatorIndex;
    FPhase       : double;
    FPitch       : double;
    FCounter     : integer;
    FAmp         : double;
    FAmpTarget   : double;
    FAmpIncrement: double;
    delayState   : TLFODelayStage;

    // Private static variables
    FPhaseStep       : double;
    FPitchModDepth   : integer;
    FAmpModDepth     : double;
    FSampleHoldRandom: integer;
    FDelayTimes      : TLFODelayAr;
    FDelayIncrements : TLFODelayAr;
    FDelayVals       : TLFODelayAr { = (0, 0, 1) };
    IsInitialized    : boolean;
  public
    constructor Create(aIndex:TOperatorIndex; const aParams:PVoiceParams);
    procedure update;
    function render:double;
    function renderAmp : double;
  end;

implementation

uses Math, SysUtils, Windows;


const
//   Freq
//  7.17                                                                                                    ###########################
//  5.49╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌##╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  3.81╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌#╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  2.13╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌##╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  0.44╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌#╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  8.76╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌#╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  7.08╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌##╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  5.40╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌#┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  3.71╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌#╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  2.03╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌##╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  0.35╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌#╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  8.67╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌#╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  6.98╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌##╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  5.30╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌##╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  3.62╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌##┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  1.94╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌#╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  0.25╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌##╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  8.57╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌##╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  6.89╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊##╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  5.21╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌##╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  3.52╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌##╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  1.84╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌##╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  0.16╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌#####╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  8.48╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌###########┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  6.79╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌###########╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  5.11╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌###########╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  3.43╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌##########╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  1.75╌┊╌╌╌╌╌###########╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//  0.06╌######╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌
//     ╌━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━
//       0        10        20        30        40        50        60        70        80        90        100       110       120
//                                                                    Index
  LFO_FREQUENCY_TABLE:TArray<double> = [ // see https://github.com/smbolton/hexter/tree/master/src/dx7_voice.c#L1002
    0.062506,  0.124815,  0.311474,  0.435381,  0.619784,
    0.744396,  0.930495,  1.116390,  1.284220,  1.496880,
    1.567830,  1.738994,  1.910158,  2.081322,  2.252486,
    2.423650,  2.580668,  2.737686,  2.894704,  3.051722,
    3.208740,  3.366820,  3.524900,  3.682980,  3.841060,
    3.999140,  4.159420,  4.319700,  4.479980,  4.640260,
    4.800540,  4.953584,  5.106628,  5.259672,  5.412716,
    5.565760,  5.724918,  5.884076,  6.043234,  6.202392,
    6.361550,  6.520044,  6.678538,  6.837032,  6.995526,
    7.154020,  7.300500,  7.446980,  7.593460,  7.739940,
    7.886420,  8.020588,  8.154756,  8.288924,  8.423092,
    8.557260,  8.712624,  8.867988,  9.023352,  9.178716,
    9.334080,  9.669644, 10.005208, 10.340772, 10.676336,
    11.011900, 11.963680, 12.915460, 13.867240, 14.819020,
    15.770800, 16.640240, 17.509680, 18.379120, 19.248560,
    20.118000, 21.040700, 21.963400, 22.886100, 23.808800,
    24.731500, 25.759740, 26.787980, 27.816220, 28.844460,
    29.872700, 31.228200, 32.583700, 33.939200, 35.294700,
    36.650200, 37.812480, 38.974760, 40.137040, 41.299320,
    42.461600, 43.639800, 44.818000, 45.996200, 47.174400,
    47.174400, 47.174400, 47.174400, 47.174400, 47.174400,
    47.174400, 47.174400, 47.174400, 47.174400, 47.174400,
    47.174400, 47.174400, 47.174400, 47.174400, 47.174400,
    47.174400, 47.174400, 47.174400, 47.174400, 47.174400,
    47.174400, 47.174400, 47.174400, 47.174400, 47.174400,
    47.174400, 47.174400, 47.174400
  ];




//     Amp
//  0.53
//  0.52╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.50╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.48╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌#╌
//  0.47╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌#╌╌
//  0.45╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌#╌╌╌
//  0.43╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌#╌╌╌╌
//  0.42╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌#╌╌╌╌╌
//  0.40╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌#╌╌╌╌╌╌
//  0.38╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊#╌╌╌╌╌╌╌
//  0.37╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌#╌╌╌╌╌╌╌╌
//  0.35╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌#┊╌╌╌╌╌╌╌╌
//  0.33╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌#╌┊╌╌╌╌╌╌╌╌
//  0.32╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌#╌╌┊╌╌╌╌╌╌╌╌
//  0.30╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌#╌╌╌┊╌╌╌╌╌╌╌╌
//  0.28╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌##╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.27╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌#╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.25╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊##╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.23╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌##╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.22╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌#╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.20╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌##╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.18╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌##╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.17╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊###╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.15╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌##╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.13╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌###╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.12╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌####╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.10╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌###╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.08╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌#####╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.07╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌######╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.05╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌########╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.03╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌############┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.02╌┊╌╌#########################╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.00╌###╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//     ╌━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━
//       0        10        20        30        40        50        60        70        80        90
//                                                      Index
LFO_AMP_MOD_TABLE:TArray<double> = [ // TODO: use lfo amp mod table
	0.00000, 0.00793, 0.00828, 0.00864, 0.00902, 0.00941, 0.00982, 0.01025, 0.01070, 0.01117,
	0.01166, 0.01217, 0.01271, 0.01327, 0.01385, 0.01445, 0.01509, 0.01575, 0.01644, 0.01716,
	0.01791, 0.01870, 0.01952, 0.02037, 0.02126, 0.02220, 0.02317, 0.02418, 0.02524, 0.02635,
	0.02751, 0.02871, 0.02997, 0.03128, 0.03266, 0.03409, 0.03558, 0.03714, 0.03877, 0.04047,
	0.04224, 0.04409, 0.04603, 0.04804, 0.05015, 0.05235, 0.05464, 0.05704, 0.05954, 0.06215,
	0.06487, 0.06772, 0.07068, 0.07378, 0.07702, 0.08039, 0.08392, 0.08759, 0.09143, 0.09544,
	0.09962, 0.10399, 0.10855, 0.11331, 0.11827, 0.12346, 0.12887, 0.13452, 0.14041, 0.14657,
	0.15299, 0.15970, 0.16670, 0.17401, 0.18163, 0.18960, 0.19791, 0.20658, 0.21564, 0.22509,
	0.23495, 0.24525, 0.25600, 0.26722, 0.27894, 0.29116, 0.30393, 0.31725, 0.33115, 0.34567,
	0.36082, 0.37664, 0.39315, 0.41038, 0.42837, 0.44714, 0.46674, 0.48720, 0.50856, 0.53283
];

//  Out
//  1.00                                                                     #
//  0.94╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌##┊╌╌╌╌╌╌╌╌
//  0.88╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌##╌┊╌╌╌╌╌╌╌╌
//  0.81╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌#╌╌╌┊╌╌╌╌╌╌╌╌
//  0.75╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌#╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.69╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌#╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.63╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌##╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.56╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊##╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.50╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌##╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.44╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌##╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.38╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌##╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.31╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌##╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.25╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌#######╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.19╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌#######╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.13╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌#####╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.06╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌################╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//  0.00╌################╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌╌┊╌╌╌╌╌╌╌╌
//     ╌━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━┻━━━━━━━━━┻━━━━━━━━━┻━━━━━━━━┻━━━━━━━━━┻━━━━━━━━
//       0         1         2        3         4         5        6         7
//                                           Index
// Wouter van Nifterick:
// these are now hard-coded values.
// Approximation formula: (Power(1.85;Index)-1)/((Power(1.85;MaxIndex))-1)
LFO_PITCH_MOD_TABLE:array of double = [
	0.0000,
  0.0264,
  0.0534,
  0.0889,
  0.1612,
  0.2769,
  0.4967,
  1.0000
];


procedure AssertInRange(val,mn,mx:double;msg:string);
begin
  Assert(inrange(val,mn,mx),Format('%s out of range [%f..%f] : %f',[msg,mn,mx,val]));
end;

constructor TLfoDX7.Create(aIndex:TOperatorIndex; const aParams:PVoiceParams);
begin
  self := default(TLfoDX7);
  self.FParams:= aParams;
  self.FOpIndex := aIndex;
	self.FPhase := 0;
	self.FPitch := 0;
	self.FCounter := 0;
	self.FAmp := 1;
	self.FAmpTarget := 1;
	self.FAmpIncrement := 0;
	self.FDelay := 0;
	self.delayState := TLFODelayStage.Onset;

  self.FSampleHoldRandom := 0;
  self.FPhaseStep :=0;
  self.FPitchModDepth := 0;

  self.FDelayTimes[TLFODelayStage.Onset   ] := 0;
  self.FDelayTimes[TLFODelayStage.Ramp    ] := 0;
  self.FDelayTimes[TLFODelayStage.Complete] := 0;

  self.FDelayIncrements[TLFODelayStage.Onset   ] := 0;
  self.FDelayIncrements[TLFODelayStage.Ramp    ] := 0;
  self.FDelayIncrements[TLFODelayStage.Complete] := 0;

  self.FDelayVals[TLFODelayStage.Onset   ] := 0;
  self.FDelayVals[TLFODelayStage.Ramp    ] := 0;
  self.FDelayVals[TLFODelayStage.Complete] := 0;

  self.IsInitialized := True;
	update();
end;

function TLfoDX7.render:double;
var
  amp:double;
  ampSensDepth :double;
  Lphase : integer;
begin
  amp := 0;
  Assert(IsInitialized,'Not initialized');
  Assert(FParams<>nil,'No params');
	if (FCounter mod config.lfoSamplePeriod) = 0 then
  begin
		case FParams.Common.LFO1.Waveform of
			TLFOWaveForm.Triangle:  if self.FPhase < config.periodHalf then amp := 4     * self.FPhase * Config.periodRecip - 1
                                                                 else amp := 3 - 4 * self.FPhase * config.periodRecip;
			TLFOWaveForm.SawDown:   		                                    amp := 1 - 2 * self.FPhase * config.periodRecip;
			TLFOWaveForm.SawUp:     		                                    amp := 2     * self.FPhase * config.periodRecip - 1;
			TLFOWaveForm.Square:    if self.FPhase < config.periodHalf then amp := -1
                                                                 else amp := 1;
			TLFOWaveForm.Sine:       		                                    amp := sin(self.FPhase);
			TLFOWaveForm.SampleHold:		                                    amp := FSampleHoldRandom;
		end;

		case self.delayState of
			TLFODelayStage.Onset,
			TLFODelayStage.Ramp:
        begin
				  self.FDelay := self.FDelay + FDelayIncrements[self.delayState];
   				if (self.FCounter / config.lfoSamplePeriod > FDelayTimes[self.delayState]) then
          begin
  					inc(self.delayState);
  					self.FDelay := FDelayVals[self.delayState];
  				end;
        end;
			TLFODelayStage.Complete:
		end;

//		if (self.counter mod 10000 = 0) and (self.Index = 0) then
//    OutputDebugString(PChar(Format('[%d] lfo amp value %f',[self.Index, self.ampVal]))) ;

    Assert(InRange(amp,-1,1));
    Assert(InRange(self.FDelay,0,1));
		amp := amp * self.FDelay;
    Assert(InRange(amp,-1,1));
    Assert(self.FParams<>nil,'No params');
    Assert(FPitchModDepth>=0);
    FPitchModDepth := trunc(1 + LFO_PITCH_MOD_TABLE[FParams.Operators[FOpIndex].Voiced.Sensitivity.vPitchEnv] * (FParams.controllerModVal + FParams.Operators[FOpIndex].Voiced.Sensitivity.vPitchEnv / 99));

    self.FPitch := power(FPitchModDepth, amp);

		// TODO: Simplify ampValTarget calculation.
		// ampValTarget range := 0 to 1.
    // lfoAmpModSens range := -3 to 3.
    // ampModDepth range :=  0 to 1.
    // amp range := -1 to 1.
    ampSensDepth := abs(self.FParams.operators[FOpIndex].Voiced.Sensitivity.AmpModSense) * (1/3);

    AssertInRange(FOpIndex,0,OPERATOR_COUNT,'index' );
    AssertInRange(FAmpTarget,0,1,'ampValTarget');
    AssertInRange(ampSensDepth,0,1,'ampSensDepth');
    AssertInRange(amp,-1,1,'amp');

    if self.FParams.operators[FOpIndex].Voiced.Sensitivity.AmpModSense > 0 then
      Lphase := 1
    else
      Lphase := -1;

		self.FAmpTarget := 1 - ((FAmpModDepth   + FParams.controllerModVal) * ampSensDepth * (amp * Lphase + 1) * 0.5);
		self.FAmpIncrement := (self.FAmpTarget - self.FAmp) / Config.lfoSamplePeriod;
		self.FPhase := self.FPhase + FPhaseStep;
		if self.FPhase >= config.period then
    begin
      case FParams.Common.LFO1.WaveForm of
        TLFOWaveForm.SampleHold :
          FSampleHoldRandom := System.Round(1 - random * 2);
      end;

			self.FPhase := self.FPhase - config.period;
		end;
	end;
	inc(FCounter);
	Result := self.FPitch;
end;

function TLfoDX7.renderAmp : double;
begin
	self.FAmp := self.FAmp + self.FAmpIncrement;
	Result := self.FAmp;
end;

procedure TLfoDX7.update;
var
  frequency: double;
begin
  Assert(FParams<>nil);
  Assert(FParams.Common.LFO1.Speed >= 0,inttostr(FParams.Common.LFO1.Speed));

  frequency   := LFO_FREQUENCY_TABLE[FParams.Common.LFO1.Speed];
  FPhaseStep   := Config.period * frequency / Config.lfoRate; // radians per sample
  FAmpModDepth := FParams.Common.LFO1.AMD {lfo.AmpModDepth} * 0.01;

  // ignoring amp mod table for now. it seems shallow LFO_AMP_MOD_TABLE[params.lfoAmpModDepth];
  FDelayTimes     [TLFODelayStage.Onset] := (Config.lfoRate * 0.001753 * power(FParams.Common.LFO1.Delay, 3.10454) + 169.344 - 168) / 1000;
  FDelayTimes     [TLFODelayStage.Ramp ] := (Config.lfoRate * 0.321877 * power(FParams.Common.LFO1.Delay, 2.01163) + 494.201 - 168) / 1000;
  FDelayIncrements[TLFODelayStage.Ramp ] := 1 / (FDelayTimes[TLFODelayStage.Ramp] - FDelayTimes[TLFODelayStage.Onset]);
end;

end.
